# OpenClaw ManServer Nginx Configuration Example
#
# 假设后端服务运行在:
# - HTTP API: 127.0.0.1:8811
# - WebSocket: 127.0.0.1:8812
#
# 此配置展示了如何通过 Nginx 将 /ocms 路径的流量分发到不同的后端端口，
# 并针对 WebSocket 和 HTTP API 进行了性能优化。

# 定义 Upstream (负载均衡/后端池)
upstream man_api_backend {
    server 127.0.0.1:8811;
    
    # 性能优化: 保持与后端的长连接，减少 TCP 握手开销
    keepalive 64;
}

upstream man_ws_backend {
    server 127.0.0.1:8812;
}

# WebSocket 升级映射
# 根据客户端请求头 Upgrade 决定 Connection 头的值
map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
}

server {
    listen 80;
    server_name your_domain.com;

    # -----------------------------------------------------------
    # 1. WebSocket 路由配置
    # 路径: /ocms/v1/stream
    # 注意: 必须放在通用 /ocms/ 规则之前，利用 Nginx 的最长前缀匹配规则
    # -----------------------------------------------------------
    location /ocms/v1/stream {
        proxy_pass http://man_ws_backend;

        # === WebSocket 核心配置 ===
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $connection_upgrade;

        # === 真实 IP 透传 ===
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # === 性能与超时设置 ===
        # WebSocket 是长连接，读取超时需要设置得比较长 (例如 1 小时)
        # 否则 Nginx 会在 60s 后自动切断没有数据的连接
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;

        # 禁用缓冲区，确保消息实时到达
        proxy_buffering off;
    }

    # -----------------------------------------------------------
    # 2. HTTP API 路由配置
    # 路径: /ocms/
    # -----------------------------------------------------------
    location /ocms/ {
        proxy_pass http://man_api_backend;

        # === HTTP 长连接优化 ===
        proxy_http_version 1.1;
        # 清除 Connection 头，允许 Nginx 与后端保持 Keep-Alive
        proxy_set_header Connection "";

        # === 真实 IP 透传 ===
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # === 缓冲区与超时 ===
        proxy_connect_timeout 60s;
        proxy_read_timeout 60s;
        proxy_send_timeout 60s;
        
        # 允许客户端上传较大文件 (如果需要上传图片/文件)
        client_max_body_size 10M;
    }
}
